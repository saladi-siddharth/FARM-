<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chat | Farm Central</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            background: #020617;
            color: white;
            height: 100vh;
            overflow: hidden;
            font-family: sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .msg-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .my-msg {
            background: #10B981;
            align-self: flex-end;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .their-msg {
            background: #334155;
            align-self: flex-start;
            color: #e2e8f0;
            border-bottom-left-radius: 2px;
        }

        #video-overlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 200px;
            background: black;
            border-radius: 10px;
            overflow: hidden;
            display: none;
            z-index: 50;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid #10B981;
        }

        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #local-video {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 80px;
            height: 60px;
            background: #333;
            border-radius: 5px;
            border: 1px solid white;
            object-fit: cover;
        }

        .call-btn {
            transition: all 0.2s;
        }

        .call-btn:active {
            transform: scale(0.95);
        }

        @keyframes popIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="flex">

    <!-- Sidebar -->
    <div class="w-1/4 glass h-full flex flex-col z-20">
        <div class="p-6 border-b border-white/10">
            <button onclick="location.href='community.html'" class="text-xs text-gray-400 hover:text-white mb-4">‚Üê Back
                to Community</button>
            <h2 class="text-2xl font-bold text-green-400">Messages</h2>
        </div>

        <div class="p-4">
            <input type="text" id="userSearch" placeholder="Search farmer..."
                class="w-full bg-black/40 p-3 rounded-lg border border-white/20 outline-none focus:border-green-500 placeholder-gray-600 transition focus:bg-black/60"
                oninput="searchUsers(this.value)">
        </div>

        <div id="userList" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
    </div>

    <!-- Chat Area -->
    <div class="flex-1 flex flex-col bg-gradient-to-br from-black to-gray-900 relative">
        <!-- Header -->
        <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black/20 backdrop-blur-md z-10">
            <div id="chatHeader" class="flex items-center gap-3">
                <div>
                    <h3 class="text-xl font-bold" id="chatName">Select a user</h3>
                    <div id="chatStatus" class="hidden flex items-center gap-2 text-xs text-green-400 font-bold">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Online
                    </div>
                </div>
            </div>
            <div id="callActions" class="hidden flex gap-4">
                <button onclick="startCall('voice')"
                    class="call-btn bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 border border-white/10">
                    üé§ <span class="hidden md:inline">Voice</span>
                </button>
                <button onclick="startCall('video')"
                    class="call-btn bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg shadow-blue-500/20">
                    üìπ <span class="hidden md:inline">Video</span>
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div id="msgContainer"
            class="flex-1 overflow-y-auto p-6 flex flex-col bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-fixed">
            <div class="text-center text-gray-500 mt-20 p-10 glass rounded-3xl mx-auto max-w-md">
                <div class="text-4xl mb-4">üëã</div>
                <h3 class="text-xl font-bold text-white mb-2">Start Connecting</h3>
                <p>Search for a fellow farmer to exchange tips, trade, or just chat.</p>
            </div>
        </div>

        <!-- Input -->
        <div class="p-4 bg-black/30 border-t border-white/10 backdrop-blur-md">
            <form id="chatForm" class="flex gap-4">
                <input type="text" id="msgInput" disabled placeholder="Type a message..."
                    class="flex-1 bg-white/5 p-4 rounded-xl outline-none focus:bg-white/10 transition border border-white/5">
                <button type="submit" id="sendBtn" disabled
                    class="bg-green-600 px-8 rounded-xl font-bold hover:bg-green-500 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-green-600/20">Send</button>
            </form>
        </div>

        <!-- Video Call Overlay -->
        <div id="video-overlay">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <button onclick="endCall()"
                class="absolute top-2 right-2 bg-red-600 p-2 rounded-full text-xs hover:bg-red-500 font-bold shadow-lg">END
                CALL</button>
        </div>
    </div>

    <script>
        // --- SETUP ---
        let currentChatId = null;
        let currentChatName = '';
        const token = localStorage.getItem('token');
        const myUsername = localStorage.getItem('username');
        let pollInterval = null;

        // --- SOCKET.IO & WebRTC ---
        const socket = io();
        let localStream;
        let peerConnection;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        if (!token) location.href = 'index.html';

        // --- CHAT LOGIC ---
        async function searchUsers(q) {
            if (q.length < 1) { document.getElementById('userList').innerHTML = ''; return; }

            const res = await fetch(`/api/chat/search?q=${q}`, { headers: { 'Authorization': token } });
            const users = await res.json();

            // Client-side filter to be absolutely sure
            const filteredUsers = users.filter(u => u.username !== myUsername);

            if (filteredUsers.length === 0) {
                document.getElementById('userList').innerHTML = '<div class="text-gray-500 text-center text-sm p-4">No other farmers found</div>';
                return;
            }

            document.getElementById('userList').innerHTML = filteredUsers.map(u => `
                <div onclick="selectUser(${u.id}, '${u.username}')" 
                    class="p-4 rounded-lg hover:bg-white/10 cursor-pointer flex items-center gap-3 transition group">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-black font-bold text-lg shadow-lg group-hover:scale-110 transition">
                        ${u.username[0].toUpperCase()}
                    </div>
                    <div>
                        <p class="font-bold text-gray-200 group-hover:text-white">${u.username}</p>
                        <p class="text-xs text-gray-400 group-hover:text-green-400">Tap to message</p>
                    </div>
                </div>
            `).join('');
        }

        async function selectUser(id, name) {
            currentChatId = id;
            currentChatName = name;

            document.getElementById('chatName').innerText = name;
            document.getElementById('chatStatus').classList.remove('hidden');
            document.getElementById('callActions').classList.remove('hidden');
            document.getElementById('msgInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('msgInput').focus();

            loadMessages();
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(loadMessages, 3000);
        }

        async function loadMessages() {
            if (!currentChatId) return;
            try {
                const res = await fetch(`/api/chat/${currentChatId}`, { headers: { 'Authorization': token } });
                const msgs = await res.json();

                const container = document.getElementById('msgContainer');
                container.innerHTML = msgs.map(m => {
                    const isMe = m.sender_username === myUsername;
                    return `
                        <div class="w-full flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="msg-bubble ${isMe ? 'my-msg shadow-green-900/50' : 'their-msg shadow-black/50'} shadow-lg">
                                ${m.content}
                                <div class="text-[9px] opacity-70 mt-1 text-right font-mono">${new Date(m.messaged_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                container.scrollTop = container.scrollHeight;
            } catch (e) { console.error(e); }
        }

        document.getElementById('chatForm').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('msgInput');
            const content = input.value.trim();
            if (!content || !currentChatId) return;

            input.value = '';
            await fetch(`/api/chat/${currentChatId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ content })
            });
            loadMessages();
        };

        // --- CALL SYSTEM (WebRTC) ---
        async function startCall(type) {
            const roomId = `call_${[currentChatName, myUsername].sort().join('_')}`;
            const constraints = { audio: true, video: type === 'video' };

            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('local-video').srcObject = localStream;
                document.getElementById('video-overlay').style.display = 'block';

                socket.emit('join-room', roomId, myUsername);
                createPeerConnection(roomId);

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('offer', { roomId, offer });

                // Auto-send link in chat
                await fetch(`/api/chat/${currentChatId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ content: `üìû [System] User started a ${type} call.` })
                });

            } catch (e) {
                alert("Error accessing devices: " + e.message);
            }
        }

        function createPeerConnection(roomId) {
            peerConnection = new RTCPeerConnection(rtcConfig);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.ontrack = (event) => {
                document.getElementById('remote-video').srcObject = event.streams[0];
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) socket.emit('ice-candidate', { roomId, candidate: event.candidate });
            };
        }

        socket.on('offer', async (data) => {
            if (!confirm("Incoming Call from " + currentChatName + ". Accept?")) return;

            createPeerConnection(data.roomId);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));

            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
            document.getElementById('local-video').srcObject = localStream;
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            document.getElementById('video-overlay').style.display = 'block';

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', { roomId: data.roomId, answer });
        });

        socket.on('answer', async (data) => {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        });

        socket.on('ice-candidate', async (data) => {
            if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        });

        function endCall() {
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (peerConnection) peerConnection.close();
            document.getElementById('video-overlay').style.display = 'none';
            window.location.reload(); // Quick reset ensures clean state
        }
    </script>
</body>

</html>