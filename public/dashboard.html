<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Farm Central | Smart Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            background: #020617;
            color: white;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
        }

        #canvas-bg {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hover-lift:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
    </style>
</head>

<body>
    <div id="canvas-bg"></div>

    <div id="auth-section" class="flex items-center justify-center min-h-screen">
        <div class="glass p-10 rounded-3xl w-full max-w-md shadow-2xl border-t-4 border-green-500">
            <h2 id="auth-title" class="text-3xl font-black text-center mb-6">FARMER LOGIN</h2>
            <form id="auth-form" class="space-y-4">
                <input type="text" id="reg-name" placeholder="Full Name"
                    class="hidden w-full p-4 rounded-xl bg-black/40 border border-white/10 outline-none">
                <input type="email" id="email" placeholder="Email" required
                    class="w-full p-4 rounded-xl bg-black/40 border border-white/10 outline-none">
                <input type="password" id="pass" placeholder="Password" required
                    class="w-full p-4 rounded-xl bg-black/40 border border-white/10 outline-none">
                <button type="submit" id="auth-btn"
                    class="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold uppercase tracking-widest">Enter
                    Hub</button>
            </form>
            <p class="text-center mt-6 text-sm text-gray-400">
                <button onclick="toggleAuth()" id="toggle-link" class="text-green-400 font-bold hover:underline">New
                    Farmer? Create Account</button>
            </p>
        </div>
    </div>

    <div id="hub-section" class="hidden min-h-screen p-6 md:p-12">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-5xl font-black text-green-400 tracking-tighter">FARM CENTRAL</h1>
                <p class="text-gray-400 font-medium">Welcome back, <span id="farmer-name"
                        class="text-white font-bold">Farmer</span></p>
            </div>
            <button onclick="logout()"
                class="glass px-6 py-2 rounded-full border border-red-500/30 text-red-400 font-bold hover:bg-red-500/10 transition">Logout</button>
        </header>

        <!-- Weather Widget -->
        <div
            class="glass p-6 rounded-3xl mb-8 flex flex-col md:flex-row items-center justify-between border-b-4 border-blue-400">
            <div class="flex items-center">
                <div id="weather-icon" class="text-6xl mr-6">üå§Ô∏è</div>
                <div>
                    <h2 class="text-2xl font-bold text-white">Farm Weather</h2>
                    <p id="weather-desc" class="text-gray-400">Loading conditions...</p>
                </div>
            </div>
            <div class="text-right mt-4 md:mt-0">
                <p id="weather-temp" class="text-5xl font-black text-white">--¬∞C</p>
                <p id="weather-wind" class="text-gray-400 font-medium">Wind: -- km/h</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="glass p-8 rounded-3xl border-l-4 border-green-500 hover-lift">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Inventory Assets</h3>
                <p id="stat-assets" class="text-4xl font-black text-white">‚Çπ0</p>
            </div>
            <div class="glass p-8 rounded-3xl border-l-4 border-red-500 hover-lift">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Total Expenses</h3>
                <p id="stat-expenses" class="text-4xl font-black text-white">‚Çπ0</p>
            </div>
            <div class="glass p-8 rounded-3xl border-l-4 border-blue-500 hover-lift">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Tasks List</h3>
                <p id="stat-tasks" class="text-4xl font-black text-white">0</p>
            </div>
            <!-- Wallet Card Removed -->
        </div>



        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Analytics Chart -->
            <div class="glass p-8 rounded-3xl border border-white/5">
                <h3 class="text-xl font-bold mb-6 flex items-center">
                    <span class="bg-yellow-500/20 text-yellow-500 p-2 rounded-lg mr-3">üìä</span>
                    Expense Analysis
                </h3>
                <div class="relative h-64 w-full">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>

            <!-- Navigation Grid -->
            <!-- Navigation Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Row 1 -->
                <button onclick="location.href='inventory.html'"
                    class="glass p-6 rounded-2xl hover:bg-green-500/10 transition border border-white/5 flex items-center group">
                    <div class="bg-green-500/20 p-4 rounded-xl mr-5 group-hover:scale-110 transition text-2xl">üì¶</div>
                    <div class="text-left">
                        <h3 class="text-lg font-bold text-white">Inventory</h3>
                        <p class="text-xs text-gray-400">Track assets</p>
                    </div>
                </button>
                <button onclick="location.href='tasks.html'"
                    class="glass p-6 rounded-2xl hover:bg-blue-500/10 transition border border-white/5 flex items-center group">
                    <div class="bg-blue-500/20 p-4 rounded-xl mr-5 group-hover:scale-110 transition text-2xl">üóìÔ∏è</div>
                    <div class="text-left">
                        <h3 class="text-lg font-bold text-white">Tasks</h3>
                        <p class="text-xs text-gray-400">Daily chores</p>
                    </div>
                </button>
                <button onclick="location.href='calendar.html'"
                    class="glass p-6 rounded-2xl hover:bg-emerald-500/10 transition border border-white/5 flex items-center group">
                    <div class="bg-emerald-500/20 p-4 rounded-xl mr-5 group-hover:scale-110 transition text-2xl">üå±
                    </div>
                    <div class="text-left">
                        <h3 class="text-lg font-bold text-white">Calendar</h3>
                        <p class="text-xs text-gray-400">Crop seasons</p>
                    </div>
                </button>

                <!-- Row 2 -->
                <button onclick="location.href='expenses.html'"
                    class="glass p-6 rounded-2xl hover:bg-yellow-500/10 transition border border-white/5 flex items-center group">
                    <div class="bg-yellow-500/20 p-4 rounded-xl mr-5 group-hover:scale-110 transition text-2xl">üí∞</div>
                    <div class="text-left">
                        <h3 class="text-lg font-bold text-white">Expenses</h3>
                        <p class="text-xs text-gray-400">Track costs</p>
                    </div>
                </button>
                <button onclick="location.href='market.html'"
                    class="glass p-6 rounded-2xl hover:bg-purple-500/10 transition border border-white/5 flex items-center group">
                    <div class="bg-purple-500/20 p-4 rounded-xl mr-5 group-hover:scale-110 transition text-2xl">üìà</div>
                    <div class="text-left">
                        <h3 class="text-lg font-bold text-white">Market</h3>
                        <p class="text-xs text-gray-400">Live prices</p>
                    </div>
                </button>
                <button onclick="location.href='community.html'"
                    class="glass p-6 rounded-2xl hover:bg-pink-500/10 transition border border-white/5 flex items-center group">
                    <div class="bg-pink-500/20 p-4 rounded-xl mr-5 group-hover:scale-110 transition text-2xl">üí¨</div>
                    <div class="text-left">
                        <h3 class="text-lg font-bold text-white">Community</h3>
                        <p class="text-xs text-gray-400">Farmer forum</p>
                    </div>
                </button>
            </div>

            <!-- Trade Banner -->
            <button onclick="location.href='trading.html'"
                class="mt-6 w-full glass p-6 rounded-2xl hover:bg-orange-500/10 transition border border-white/5 flex items-center justify-between group border-l-4 border-orange-500">
                <div class="flex items-center">
                    <div class="bg-orange-500/20 p-4 rounded-xl mr-5 group-hover:scale-110 transition text-2xl">ü§ù</div>
                    <div class="text-left">
                        <h3 class="text-lg font-bold text-white">Direct Trade Hub</h3>
                        <p class="text-xs text-gray-400">Sell directly to customers (Peer-to-Peer)</p>
                    </div>
                </div>
                <div class="text-orange-400 font-bold group-hover:translate-x-2 transition">Enter Hub ‚Üí</div>
            </button>
        </div>
    </div>

    </div>

    <script>
        // --- 3D BG ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-bg').appendChild(renderer.domElement);
        const geometry = new THREE.TorusKnotGeometry(10, 3, 100, 16);
        const material = new THREE.MeshNormalMaterial({ wireframe: true });
        const torus = new THREE.Mesh(geometry, material);
        scene.add(torus);
        camera.position.z = 30;
        function animate() { requestAnimationFrame(animate); torus.rotation.x += 0.005; renderer.render(scene, camera); }
        animate();

        // --- LOGIC ---
        let isLogin = true;
        const token = localStorage.getItem('token');
        if (token) showHub();

        function toggleAuth() {
            isLogin = !isLogin;
            document.getElementById('reg-name').classList.toggle('hidden');
            document.getElementById('auth-title').innerText = isLogin ? 'FARMER LOGIN' : 'CREATE ACCOUNT';
            document.getElementById('auth-btn').innerText = isLogin ? 'Enter Hub' : 'Register Farm';
        }

        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const endpoint = isLogin ? '/api/auth/signin' : '/api/auth/signup';
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email.value,
                    password: pass.value,
                    username: document.getElementById('reg-name').value
                })
            });
            const data = await res.json();
            if (res.ok) {
                if (isLogin) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('username', data.username);
                    showHub();
                } else { alert("Registered! Please login."); toggleAuth(); }
            } else { alert(data.error); }
        };

        async function showHub() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('hub-section').classList.remove('hidden');
            document.getElementById('farmer-name').innerText = localStorage.getItem('username');

            // FETCH REFRESHED STATS
            try {
                const res = await fetch('/api/dashboard/summary', {
                    headers: { 'Authorization': localStorage.getItem('token') }
                });
                const stats = await res.json();

                // Note: Keys must match server/routes/dashboard.js
                document.getElementById('stat-assets').innerText = `‚Çπ${Number(stats.inventoryValue).toLocaleString()}`;
                document.getElementById('stat-expenses').innerText = `‚Çπ${Number(stats.totalExpenses).toLocaleString()}`;
                document.getElementById('stat-tasks').innerText = stats.taskCount;

                // Render Chart
                renderChart(stats.expenseBreakdown);
            } catch (err) { console.error("Sync Error", err); }
        }

        // --- WEATHER LOGIC ---
        async function fetchWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    getWeatherData(lat, lon);
                }, () => {
                    getWeatherData(20.5937, 78.9629); // Default: India
                });
            } else {
                getWeatherData(20.5937, 78.9629);
            }
        }

        async function getWeatherData(lat, lon) {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                const data = await res.json();
                const temp = data.current_weather.temperature;
                const wind = data.current_weather.windspeed;
                const code = data.current_weather.weathercode;

                document.getElementById('weather-temp').innerText = `${temp}¬∞C`;
                document.getElementById('weather-wind').innerText = `Wind: ${wind} km/h`;

                // Simple weather code mapping
                const weatherMap = { 0: '‚òÄÔ∏è Clear Sky', 1: 'üå§Ô∏è Mainly Clear', 2: '‚õÖ Partly Cloudy', 3: '‚òÅÔ∏è Overcast', 45: 'üå´Ô∏è Fog', 51: 'DRIZZLE', 61: 'RAIN', 71: 'SNOW', 95: 'THUNDERSTORM' };
                let desc = weatherMap[code] || 'Unknown';
                if (code >= 51 && code <= 55) desc = 'üåßÔ∏è Drizzle';
                if (code >= 61 && code <= 65) desc = 'üåßÔ∏è Rain';
                if (code >= 80 && code <= 82) desc = 'üå¶Ô∏è Showers';

                document.getElementById('weather-desc').innerText = desc;

            } catch (e) { console.log('Weather Error', e); }
        }

        fetchWeather();

        // --- CHART LOGIC ---
        let chartInstance = null;
        function renderChart(data) {
            const ctx = document.getElementById('expenseChart').getContext('2d');

            if (chartInstance) chartInstance.destroy();

            const labels = data.map(d => d.category || 'Uncategorized');
            const values = data.map(d => d.total);
            const colors = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: 'white' } }
                    }
                }
            });
        }

        // --- WITHDRAWAL LOGIC ---
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>

</html>